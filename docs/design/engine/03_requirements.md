# 3. 要件定義

## 3.1 機能要件

- **F-01 推定計算 (E) の評価**  
  `calc_type="E"` を指定して Lab-Aid スクリプトを実行すると、元システムと同一の `(raw, edited, reported)` を返す。推定計算式には `this =` を最低 1 回含める。
- **F-02 丸め計算 (R) の評価**  
  `calc_type="R"` を指定して Lab-Aid 丸め計算式を実行すると、`(None, edited, reported)` を Lab-Aid 互換仕様で返す。丸め計算式にも `this =` を最低 1 回含め、`#` 変数は使用しない。
- **F-03 `#CODE[UNIT]` 入力の解釈**  
  E モードの入力文字列から `#CODE`、`#CODE[UNIT]`、`#HOLDER.CODE` や `#HOLDER.CODE[UNIT]` といった階層付き表記を解析し、`Engine.items` に値と `VarRef` を格納する。
- **F-04 IF/ELSE/END 制御**  
  Lab-Aid 記法の条件分岐をネスト深度 10 までサポートし、整合しない場合は仕様通りのエラー文字列を返す。
- **F-05 FOR/NEXT 制御**  
  FOR ループをネスト深度 10、反復回数 1,000,000 まで許容し、超過時はエラーとする。`step` 省略時は ±1 を自動補完。
- **F-06 ビルトイン関数の互換性**  
  数値・文字列・印字系のビルトインを実装し、引数制約やフォーマットヒントを Lab-Aid 仕様に揃える。
- **F-07 エラー時の互換文字列**  
  例外が発生した際に `"エラー"` を返し、既存システムと同じ挙動（E: `("エラー", None, None)`, R: `(None, "エラー", "エラー")`）を保証する。
- **F-08 Excel CLI**  
  エンジン成果物の一部として `lab_aid/excel_cli.py` を提供し、`lab_aid_input.xlsx` から行単位でエンジンを呼び出して結果列へ書き戻す。
- **F-09 Windows 配布スクリプト**  
  エンジン成果物の一部として `windows/run_lab_aid.cmd` や `windows/setup_lab_aid.ps1` を提供し、ユーザーが Python を意識せず CLI を実行できるようにする。
- **F-10 テストスイート**  
  `pytest tests/engine_test.py` を実行すると、E/R 代表ケース・ビルトイン・エラー系の回帰テストが通る。

## 3.2 非機能要件

- **パフォーマンス**: E/R スクリプト評価は 1 件あたり 200 ms 以内（参考値: 1,000 件を 3 分以内）を目標とし、CI で 500 件テストを実行可能にする。
- **対応プラットフォーム**: Python 3.13 以上。CLI は Windows 10/11 での利用を想定し、PowerShell 5.1+ でセットアップ可能であること。
- **依存ライブラリ**: `openpyxl`、`click`（CLI 用）、`pytest`、`ruff` を利用し、`pyproject.toml` と `uv.lock` でバージョンを固定する。
- **セキュリティ**: 外部ファイルアクセスは `lab_aid_input.xlsx` とスクリプトで指定された範囲に限定し、任意コード実行につながる AST ノード（`lambda` など）はパース段階で拒否する。
- **ロギング**: CLI 実行時に処理件数と失敗行を標準出力へ表示し、エンジン内部では例外の詳細を `logging` DEBUG レベルで記録可能にする。
- **可用性**: setup スクリプトはオフラインインストール（事前ダウンロードした Python 埋め込み版）にも対応し、組織内配布を想定する。
- **ドキュメント**: `docs/design/engine` に 9 章構成の設計書を整備し、`docs/guidelines` でユーザーガイドを提供する。
- **テスト性**: `pytest` による単体テストに加え、Excel CLI を用いた手動検証手順を `docs/guidelines` に記載する。
